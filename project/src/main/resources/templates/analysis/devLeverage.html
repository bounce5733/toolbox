<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>研发杠杆</title>
    <link rel="stylesheet" href="../static/css/index.css">
    <link rel="stylesheet" href="../static/css/element.css">
  </head>
  <body>
    <div id="app" class="app-container">
      <el-form :inline="true" @submit.native.prevent>
        <el-row>
          <el-form-item label="维度">
            <el-select v-model="params.dimension" @change="dimensionChange">
              <el-option v-for="(val, key) in dimensionMap" :label="val" :value="key" :key="key"></el-option>
            </el-select>
          </el-form-item>
          <el-form-item label="周期">
            <el-date-picker type="date" v-model="params.trendStart" value-format="yyyy/MM/dd"></el-date-picker>
            &nbsp;-&nbsp;
            <el-date-picker type="date" v-model="params.trendEnd" value-format="yyyy/MM/dd"></el-date-picker>
          </el-form-item>
          <el-form-item>
            <el-button type="primary" @click="query" icon="el-icon-search">查询</el-button>
          </el-form-item>
        </el-row>
      </el-form>
      <div id="chart" style="width:100%; height:400px"></div>
    </div>
  </body>
  <script src="../static/js/util.js"></script>
  <script src="../static/js/vue.js"></script>
  <script src="../static/js/element.js"></script>
  <script src="../static/js/axios.js"></script>
  <script src="../static/js/echarts.js"></script>

  <script>
    new Vue({
      el: '#app',

      data: function() {
        return {
          dimensionMap: {'0': '小组', '1': '部门', '2': '条线'}, // 查询维度
          dictMap: {}, // 系统字典
          personnelMap: {}, // 人员字典
          params: { dimension: '0' },
          // --------------图表--------------
          myChart: undefined,
          option: {
            title: {
              text: ''
            },
            tooltip: {
              trigger: 'axis'
            },
            legend: {
              data: []
            },
            grid: {
              left: '3%',
              right: '4%',
              bottom: '3%',
              containLabel: true
            },
            toolbox: {
              feature: {
                saveAsImage: {}
              }
            },
            xAxis: {
              type: 'category',
              boundaryGap: false,
              data: []
            },
            yAxis: {
              type: 'value'
            },
            series: []
          }
        }
      },
      methods: {
        async query() {
          axios.get('/rest/dict/load').then(res => {
            this.dictMap = res.data
            axios.get('/rest/personnel/load').then(res => {
              res.data.forEach(item =>  {
                this.personnelMap[item.id] = item
              })
              axios.get('/rest/resource/load').then(res => {
                console.log('resources:' + JSON.stringify(res.data))
                const dataMap = {}
                const dateSet = new Set() // 记录所有小组出现的时间
                const chartTmpData = {} // 图表数据中间容器
                let sortedTmpData = []
                const chartData = {} // 图表数据容器
                const serieses = []
                let sortDateArr = []
                let sortedNames = []
                switch(this.params.dimension) {
                  case '0': // 小组
                    res.data.forEach(resource => {
                      const person = this.personnelMap[resource.personnelId]
                      const startDate = resource.startDate.substr(0, 7) // 截取年月
                      console.log('startDate:' + startDate)
                      if (!dataMap[person.team]) {
                        dataMap[person.team] = {}
                      }
                      if (!dataMap[person.team][startDate]) {
                        dataMap[person.team][startDate] = {}
                      }
                      dataMap[person.team][startDate][person.type] = dataMap[person.team][startDate][person.type] ? dataMap[person.team][startDate][person.type] + 1 : 1
                    })
                    console.log('dataMap:' + JSON.stringify(dataMap))
                    Object.keys(dataMap).forEach(teamKey => {
                      if (!chartTmpData[teamKey]) {
                        chartTmpData[teamKey] = {}
                      }
                      const dates = Object.keys(dataMap[teamKey]).sort()
                      dates.forEach(date => {
                        dateSet.add(date)
                        let rate = 0
                        if (dataMap[teamKey][date]['1'] !== undefined && dataMap[teamKey][date]['2'] !== undefined) {
                          rate = dataMap[teamKey][date]['2'] / dataMap[teamKey][date]['1']
                        }
                        chartTmpData[teamKey][date] = rate
                      })
                    })
                    sortDateArr = Array.from(dateSet).sort()
                    sortedTmpData = Object.keys(chartTmpData).sort()
                    sortedTmpData.forEach(team => {
                      const teamDates = Object.keys(chartTmpData[team]).sort
                      const vals = []
                      sortDateArr.forEach(date => {
                        if (chartTmpData[team][date]) {
                          vals.push(chartTmpData[team][date])
                        } else {
                          vals.push(0)
                        }
                      })
                      chartData[team] = vals
                    })
                    console.log('chartData:' + JSON.stringify(chartData))
                    
                    sortedTmpData.forEach(team => {
                      const series = {
                        name: this.dictMap['TEAM'][team],
                        type: 'line',
                        stack: 'Total',
                        data: chartData[team]
                      }
                      serieses.push(series)
                    })
                    console.log('sortedTmpData:' + JSON.stringify(sortedTmpData))
                    console.log('sortDateArr:' + JSON.stringify(sortDateArr))
                    console.log('serieses:' + JSON.stringify(serieses))
                    sortedTmpData.forEach(team => {
                      sortedNames.push(this.dictMap['TEAM'][team])
                    })
                    this.option.title.text = '小组研发杠杆'
                    this.option.legend.data = sortedNames
                    this.option.xAxis.data = sortDateArr
                    this.option.series = serieses
                    break;
                    // 组装图表数据
                  case '1': // 部门
                    res.data.forEach(resource => {
                      const person = this.personnelMap[resource.personnelId]
                      const startDate = resource.startDate.substr(0, 7) // 截取年月
                      console.log('startDate:' + startDate)
                      if (!dataMap[person.dept]) {
                        dataMap[person.dept] = {}
                      }
                      if (!dataMap[person.dept][startDate]) {
                        dataMap[person.dept][startDate] = {}
                      }
                      dataMap[person.dept][startDate][person.type] = dataMap[person.dept][startDate][person.type] ? dataMap[person.dept][startDate][person.type] + 1 : 1
                    })
                    console.log('dataMap:' + JSON.stringify(dataMap))
                    Object.keys(dataMap).forEach(deptKey => {
                      if (!chartTmpData[deptKey]) {
                        chartTmpData[deptKey] = {}
                      }
                      const dates = Object.keys(dataMap[deptKey]).sort()
                      dates.forEach(date => {
                        dateSet.add(date)
                        let rate = 0
                        if (dataMap[deptKey][date]['1'] !== undefined && dataMap[deptKey][date]['2'] !== undefined) {
                          rate = dataMap[deptKey][date]['2'] / dataMap[deptKey][date]['1']
                        }
                        chartTmpData[deptKey][date] = rate
                      })
                    })
                    sortDateArr = Array.from(dateSet).sort()
                    sortedTmpData = Object.keys(chartTmpData).sort()
                    sortedTmpData.forEach(dept => {
                      const deptDates = Object.keys(chartTmpData[dept]).sort
                      const vals = []
                      sortDateArr.forEach(date => {
                        if (chartTmpData[dept][date]) {
                          vals.push(chartTmpData[dept][date])
                        } else {
                          vals.push(0)
                        }
                      })
                      chartData[dept] = vals
                    })
                    console.log('chartData:' + JSON.stringify(chartData))
                    sortedTmpData.forEach(dept => {
                      const series = {
                        name: this.dictMap['DEPT'][dept],
                        type: 'line',
                        stack: 'Total',
                        data: chartData[dept]
                      }
                      serieses.push(series)
                    })
                    console.log('sortedTmpData:' + JSON.stringify(sortedTmpData))
                    console.log('sortDateArr:' + JSON.stringify(sortDateArr))
                    console.log('serieses:' + JSON.stringify(serieses))
                    sortedTmpData.forEach(dept => {
                      sortedNames.push(this.dictMap['DEPT'][dept])
                    })
                    this.option.title.text = '部门研发杠杆'
                    this.option.legend.data = sortedNames
                    this.option.xAxis.data = sortDateArr
                    this.option.series = serieses
                    break;
                  case '2': // 条线
                    break;
                  default:
                }
                this.myChart.setOption(this.option)
              })
            })
          })
        },
        dimensionChange() {
          this.query()
        }
      },
      mounted() {
        this.query()
        this.myChart = echarts.init(document.getElementById('chart'))
      }
    })
  </script>
</html>